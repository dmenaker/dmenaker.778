<!DOCTYPE html>
<html lang="en">
<head>
  <title>Resident Reporting</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
    
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css"/>
    
    <!-- Load Leaflet from CDN -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
        integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
        crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
        integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
        crossorigin="">
    </script>

    <!-- Load Esri Leaflet from CDN -->
    <script src="https://unpkg.com/esri-leaflet@3.0.4/dist/esri-leaflet.js"></script>
    <script src="https://unpkg.com/esri-leaflet-vector@3.0.0/dist/esri-leaflet-vector.js"></script>

    <!-- Load Esri Leaflet from CDN -->
    <script src="https://unpkg.com/esri-leaflet@3.0.7/dist/esri-leaflet.js" 
        integrity="sha512-ciMHuVIB6ijbjTyEdmy1lfLtBwt0tEHZGhKVXDzW7v7hXOe+Fo3UA1zfydjCLZ0/vLacHkwSARXB5DmtNaoL/g=="
        crossorigin="">
    </script>

    <!-- Load Esri Leaflet Vector from CDN -->
    <script src="https://unpkg.com/esri-leaflet-vector@3.1.2/dist/esri-leaflet-vector.js"
        integrity="sha512-SnA/TobYvMdLwGPv48bsO+9ROk7kqKu/tI9TelKQsDe+KZL0TUUWml56TZIMGcpHcVctpaU6Mz4bvboUQDuU3w=="
        crossorigin="">
    </script>
    
    
    <!-- Load Esri Leaflet Geocoder from CDN -->
    <link rel="stylesheet" href="https://unpkg.com/esri-leaflet-geocoder@3.0.0/dist/esri-leaflet-geocoder.css"/>
    <script src="https://unpkg.com/esri-leaflet-geocoder@3.0.0/dist/esri-leaflet-geocoder.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>

    <link rel="stylesheet" href="css/style.css"/>
    
    <style>
    /* Set height of the grid so .sidenav can be 100% (adjust if needed) */
    .row.content {height: 850px}
    
    /* Set gray background color and 100% height */
    .sidenav {
      background-color: #f1f1f1;
      height: 100%;
    }
    
    /* Set black background color, white text and some padding */
    footer {
      background-color: #555;
      color: white;
      padding: 15px;
    }
    
    /* On small screens, set height to 'auto' for sidenav and grid */
    @media screen and (max-width: 767px) {
      .sidenav {
        height: auto;
        padding: 15px;
      }
      .row.content {height: auto;} 
    }
  </style>
    
    
</head>
    
<body>
<!--create div for map title and info button-->
    <div id="maptitle"><p id="mapT">Plumsted Township Resident Reporting Tool<button class = "info"><img src = 'img/info.png'></button></p>
    </div>
    <div class="container-fluid">
      <div class="row content">
        <div class="col-sm-2 sidenav">
          <h4>Report New Issue</h4>
            <div class="form-group">
              <select id="Report">
                  <option value="UPD">Utility Pole Damaged</option>
                  <option value="UWD">Utility Wire Down</option>
                  <option value="BUW">Branch on Utility Wire</option>
                  <option value="NGL">Natural Gas Leak</option>
                  <option value="PWL">Water Leak</option>
                  <option value="GNC">Garbage Not Collected</option>
                  <option value="RNC">Recycling Not Collected</option>
                  <option value="SCS">Snow Covering Sidewalk</option>
                  <option value="SUP">Street Unplowed</option>
                  <option value="LOR">Litter in/on Side of Road</option>
                  <option value="DRE">Damaged Recreational Equipment</option>
                  <option value="MSS">Missing Street Sign</option>
                  <option value="DSL">Damaged Street Light</option>
                  <option value="DTS">Damaged Traffic Signal</option>
                  <option value="DAC">Dead Animal</option>
              </select>
            </div>
            <form>
                <h4>Priority</h4>
              <label class="radio-inline"><input type="radio" name="priority" value="High">High</label>
              <label class="radio-inline"><input type="radio" name="priority" value="Moderate">Moderate</label>
              <label class="radio-inline"><input type="radio" name="priority" value="Low">Low</label>
            </form>
            <form>
                <h4>Status</h4>
              <label class="radio-inline"><input type="radio" name="status" value="Active" checked>Active</label>
            </form>
        </div>
        <div id="map" class="col-sm-10">
        </div>
      </div>
    </div>
    
    <script>
        const NELAT = 40.072466;
        const NELONG = -74.493870;
        
        const apiKey = "AAPK1e16693748da4ddba76fb41f2989c061AgGwancIT9TT8VytqRN7fzWLhovcNEpSpCQKkhXU6e6JuZELJk0Wnntc4naJwiqI";
        
        const basemapEnum = "ArcGIS:Navigation";
        
        const map = L.map("map", {
            minZoom: 2
        }).setView([40.072466, -74.493870], 12); //Center the view to New Egypt, NJ
        L.esri.Vector.vectorBasemapLayer(basemapEnum, {
            apiKey: apiKey
        }).addTo(map);

//Seach tool for finding a location
//Drops a point marker on the map and displays a popup with the address and lat/long
        const searchControl = L.esri.Geocoding.geosearch({
            position: "topright",
            placeholder: "Enter an address or place e.g. 102 Hawkin Rd",
            useMapBounds: false,
            providers: [
                L.esri.Geocoding.arcgisOnlineProvider({
                    apikey: apiKey,
                    nearby: {
                    lat: NELAT,
                    lng: NELONG
                    }
                })
            ]
        }).addTo(map);

        const results = L.layerGroup().addTo(map);
        
        searchControl.on("results", (data) => {
            results.clearLayers();
            for (let i = data.results.length - 1; i >= 0; i--) {
                const lngLatString = `${Math.round(data.results[i].latlng.lng * 100000) / 100000}, ${Math.round(data.results[i].latlng.lat * 100000) / 100000
                }`;
                const marker = L.marker(data.results[i].latlng);
                marker.bindPopup(`<b>${lngLatString}</b><p>${data.results[i].properties.LongLabel}</p>`);
                results.addLayer(marker);
                marker.openPopup();
            }
        });
      
        const geocoder = L.esri.Geocoding.geocodeService({
            apikey: apiKey
        });

//Drop a point marker and display the address and lat/long by clicking on the map
/*        const layerGroup = L.layerGroup().addTo(map);

        map.on("click", function (e) {
            geocoder
                .reverse()
                .latlng(e.latlng)
                .run(function (error, result) {
                if (error) {
                    return;
                }
                
                const lngLatString = `${Math.round(result.latlng.lng * 100000) / 100000}, ${Math.round(result.latlng.lat * 100000) / 100000}`;
                
                layerGroup.clearLayers();
                marker = L.marker(result.latlng)
                    .addTo(layerGroup)
                    .bindPopup(`<b>${lngLatString}</b><p>${result.address.Match_addr}</p>`)
                    .openPopup();
                });
        });
        
        */
        
        //Add feature layer to map
        var reports = L.esri
        .featureLayer({
            url: "https://services.arcgis.com/HRPe58bUyBqyyiCt/arcgis/rest/services/resident_hazard_report/FeatureServer/0"
        }).addTo(map);
        
        //Create pop up
        reports.bindPopup(function (layer) {
            return L.Util.template(
                "<p>Issue Reported: {ReportType}</p>",
                layer.feature.properties
            );
        });
        
        
        var report = document.querySelector('#Report');
        //const priority = document.querySelector("#priority");
        //const status = document.querySelector("#status");
        
        map.on('click', function (e) {
            const feat = L.marker(e.latlng).toGeoJSON();
            feat.properties.ReportType = report.value;
            //feat.properties.priority = priority.value;
            //feat.properties.status = status.value;
            reports.addFeature(feat, function (err, response) {
                if (err) {
                    return;
                }
                console.log(response);
            });
        });
        
    </script>

    </body>
</html>