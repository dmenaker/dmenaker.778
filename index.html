<!DOCTYPE html>
<html lang="en">
<head>
  <title>Resident Reporting</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
    
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css"/>
    
    <!-- Load Leaflet from CDN -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
        integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
        crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
        integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
        crossorigin="">
    </script>

    <!-- Load Esri Leaflet from CDN -->
    <script src="https://unpkg.com/esri-leaflet@3.0.4/dist/esri-leaflet.js"></script>
    <script src="https://unpkg.com/esri-leaflet-vector@3.0.0/dist/esri-leaflet-vector.js"></script>

    <!-- Load Esri Leaflet from CDN -->
    <script src="https://unpkg.com/esri-leaflet@3.0.7/dist/esri-leaflet.js" 
        integrity="sha512-ciMHuVIB6ijbjTyEdmy1lfLtBwt0tEHZGhKVXDzW7v7hXOe+Fo3UA1zfydjCLZ0/vLacHkwSARXB5DmtNaoL/g=="
        crossorigin="">
    </script>

    <!-- Load Esri Leaflet Vector from CDN -->
    <script src="https://unpkg.com/esri-leaflet-vector@3.1.2/dist/esri-leaflet-vector.js"
        integrity="sha512-SnA/TobYvMdLwGPv48bsO+9ROk7kqKu/tI9TelKQsDe+KZL0TUUWml56TZIMGcpHcVctpaU6Mz4bvboUQDuU3w=="
        crossorigin="">
    </script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/0.4.2/leaflet.draw.css"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/0.4.2/leaflet.draw.js"></script>
    
    <!-- Load Esri Leaflet Geocoder from CDN -->
    <link rel="stylesheet" href="https://unpkg.com/esri-leaflet-geocoder@3.0.0/dist/esri-leaflet-geocoder.css"/>
    <script src="https://unpkg.com/esri-leaflet-geocoder@3.0.0/dist/esri-leaflet-geocoder.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>

    <link rel="stylesheet" href="css/style.css"/>
  
      <style>
    /* Set height of the grid so .sidenav can be 100% (adjust if needed) */
    .row.content {height: 850px}
    
    /* On small screens, set height to 'auto' for sidenav and grid */
    @media screen and (max-width: 767px) {
      .sidenav {
        height: auto;
        padding: 15px;
      }
      .row.content {height: auto;} 
    }
  </style>
</head>
    
<body>
<!--create div for map title and info button-->
    <div id="maptitle"><p id="mapT">Plumsted Township Resident Reporting Tool</div>
    <div class="container-fluid">
      <div class="row content">
        <div id="map">
        </div>
      </div>
    </div>
 
    
    <script>
        const NELAT = 40.072466;
        const NELONG = -74.493870;
        
        const apiKey = "AAPK1e16693748da4ddba76fb41f2989c061AgGwancIT9TT8VytqRN7fzWLhovcNEpSpCQKkhXU6e6JuZELJk0Wnntc4naJwiqI";
        
        const basemapEnum = "ArcGIS:Navigation";
        
        let latlng;
        
        const map = L.map("map", {
            drawControl: false,
            minZoom: 2
            }).setView([40.072466, -74.493870], 12); //Center the view to New Egypt, NJ
            L.esri.Vector.vectorBasemapLayer(basemapEnum, {
            apiKey: apiKey
        }).addTo(map);


        //Drops a point marker on the map and displays a popup with the address and lat/long
        const searchControl = L.esri.Geocoding.geosearch({
            position: "topright",
            placeholder: "Enter an address or place e.g. 102 Hawkin Rd",
            useMapBounds: true,
            providers: [
                L.esri.Geocoding.arcgisOnlineProvider({
                    apikey: apiKey,
                    nearby: {
                    lat: NELAT,
                    lng: NELONG
                    }
                })
            ]
        }).addTo(map);

        const results = L.layerGroup().addTo(map);
        
        searchControl.on("results", (data) => {
            results.clearLayers();
            for (let i = data.results.length - 1; i >= 0; i--) {
                const lngLatString = `${Math.round(data.results[i].latlng.lng * 100000) / 100000}, ${Math.round(data.results[i].latlng.lat * 100000) / 100000
                }`;
                const marker = L.marker(data.results[i].latlng);
                marker.bindPopup(dropdown);
                results.addLayer(marker);
                marker.openPopup();
            }
        });
      
        const geocoder = L.esri.Geocoding.geocodeService({
            apikey: apiKey
        });

        //Define the pop up form for a new marker point
        const dropdown =
            `<h4>Issue to Report:</h4><p>
            <select id="report">
                <option value="Utility Pole Damaged">Utility Pole Damaged</option>
                <option value="Utility Wire Down">Utility Wire Down</option>
                <option value="Branch on Utility Wire">Branch on Utility Wire</option>
                <option value="Natural Gas Leak">Natural Gas Leak</option>
                <option value="Water Leak">Water Leak</option>
                <option value="Garbage Not Collected">Garbage Not Collected</option>
                <option value="Recycling Not Collected">Recycling Not Collected</option>
                <option value="Snow Covering Sidewalk">Snow Covering Sidewalk</option>
                <option value="Street Unplowed">Street Unplowed</option>
                <option value="Litter in/on Side of Road">Litter in/on Side of Road</option>
                <option value="Damaged Recreational Equipment">Damaged Recreational Equipment</option>
                <option value="Missing Street Sign">Missing Street Sign</option>
                <option value="Damaged Street Light">Damaged Street Light</option>
                <option value="Damaged Traffic Signal">Damaged Traffic Signal</option>
                <option value="Dead Animal">Dead Animal</option>
            </select><p>
            <h4>Priority:</h4>
                <label class="radio-inline"><input type="radio" name="priority" value="High">High</label>
                <label class="radio-inline"><input type="radio" name="priority" value="Moderate">Moderate</label>
                <label class="radio-inline"><input type="radio" name="priority" value="Low">Low</label><p>
            <h4>Status</h4>
                <label class="radio-inline"><input type="radio" name="status" value="Active" checked>Active</label><p><br>
            <button onclick="buttonFunction()">SUBMIT</button>`;
        
        //set new marker
        map.on('click', e => {
            const popup = L.popup()
            .setLatLng(e.latlng)
            .setContent(dropdown)
            .openOn(map);
            latLng = e.latlng;
        });
        
        buttonFunction = () => {
            const dropdownValue = document.getElementById("report").value;
            map.closePopup()
            L.marker(latLng)
            .bindPopup(dropdownValue)
            .addTo(map)
        };
                
        //Add feature layer to map
        var reports = L.esri.featureLayer({
            url: "https://services.arcgis.com/HRPe58bUyBqyyiCt/arcgis/rest/services/resident_hazard_report/FeatureServer/0"
        }).addTo(map);
        
        
        //Create pop up for feature layer
        reports.bindPopup(function (layer) {
            return L.Util.template(
                "<p>Issue Reported: {ReportType}</p>",
                layer.feature.properties
            );
        });
        
    </script>
    </body>
</html>